<div class="queue-container">
  <div class="queue-body">
    $queue_rows
  </div>
</div>
<script>
(function () {
  function getBridgeInputEl() {
    const container = document.getElementById('queue-action-input');
    return container ? container.querySelector('textarea') : null;
  }
  function getBridgeTriggerBtn() {
    const container = document.getElementById('queue-action-trigger');
    return container ? container.querySelector('button') : null;
  }

  function sendQueueAction(action, jobId) {
    try {
      const inputEl = getBridgeInputEl();
      const triggerBtn = getBridgeTriggerBtn();
      if (!inputEl || !triggerBtn) {
        console.warn('Queue action bridge components not found.');
        return;
      }
      const payload = JSON.stringify({ action, job_id: jobId });
      inputEl.value = payload;
      // Inform Gradio the hidden textbox value changed
      inputEl.dispatchEvent(new Event('input', { bubbles: true }));
      // Trigger Gradio callback
      triggerBtn.click();
    } catch (e) {
      console.error('Error sending queue action:', e);
    }
  }

  function bindQueueActionButtons(root = document) {
    const buttons = root.querySelectorAll('.queue-row-action-btn');
    buttons.forEach((btn) => {
      if (btn.dataset.bound === '1') return;
      btn.dataset.bound = '1';
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const action = btn.getAttribute('data-action');
        const jobId = btn.getAttribute('data-job-id');
        if (!action || !jobId) return;
        // Optimistically disable to avoid double clicks
        btn.setAttribute('disabled', 'disabled');
        sendQueueAction(action, jobId);
      });
    });
  }

  // Initial bind on load
  bindQueueActionButtons();

  // Observe queue for dynamic updates and bind newly added buttons
  const queueBody = document.querySelector('.queue-body');
  if (queueBody) {
    const observer = new MutationObserver((mutations) => {
      let shouldRebind = false;
      mutations.forEach((m) => {
        if (m.addedNodes && m.addedNodes.length > 0) {
          shouldRebind = true;
        }
      });
      if (shouldRebind) {
        bindQueueActionButtons(queueBody);
      }
    });
    observer.observe(queueBody, { childList: true, subtree: true });
  }
})();
</script>
